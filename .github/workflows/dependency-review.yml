name: 'ä¾èµ–å®¡æŸ¥'
on:
  pull_request:
    branches: ["main"]
    paths:
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: 'æ£€å‡ºä»£ç åº“'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: 'è®¾ç½® Node.js ç¯å¢ƒ'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'

      - name: 'ä¾èµ–å®¡æŸ¥'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          comment-summary-in-pr: always
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'å®‰è£…ä¾èµ–'
        run: npm ci

      - name: 'å®‰å…¨å®¡è®¡'
        id: audit
        run: |
          echo "## ğŸ”’ å®‰å…¨å®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          AUDIT_OUTPUT=$(npm audit --audit-level=moderate 2>&1 || true)

          if echo "$AUDIT_OUTPUT" | grep -q "found 0 vulnerabilities"; then
            echo "âœ… æœªå‘ç°å·²çŸ¥æ¼æ´" >> $GITHUB_STEP_SUMMARY
            echo "audit_status=clean" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ å‘ç°æ¼æ´ï¼š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$AUDIT_OUTPUT" | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "audit_status=warning" >> $GITHUB_OUTPUT
          fi

      - name: 'è®¸å¯è¯æ£€æŸ¥'
        id: license
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“œ è®¸å¯è¯åˆè§„æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“Š è®¸å¯è¯æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          npx --yes license-checker-rseidelsohn --summary >> $GITHUB_STEP_SUMMARY

          FORBIDDEN_LICENSES="GPL-2.0-only,GPL-2.0-or-later,GPL-3.0-only,GPL-3.0-or-later,AGPL-3.0-only,AGPL-3.0-or-later,LGPL-2.0-only,LGPL-2.0-or-later,LGPL-2.1-only,LGPL-2.1-or-later,LGPL-3.0-only,LGPL-3.0-or-later"
          
          VIOLATIONS=$(npx --yes license-checker-rseidelsohn --failOn "$FORBIDDEN_LICENSES" 2>&1 || true)
          
          if echo "$VIOLATIONS" | grep -q "package(s) using a forbidden license"; then
            echo "âŒ **æ£€æµ‹åˆ°è®¸å¯è¯è¿è§„ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "ä»¥ä¸‹åŒ…ä½¿ç”¨äº†å—é™è®¸å¯è¯ï¼š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$VIOLATIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "license_status=violation" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ‰€æœ‰ä¾èµ–å‡ç¬¦åˆè®¸å¯è¯æ”¿ç­–ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "license_status=ok" >> $GITHUB_OUTPUT
          fi

      - name: 'ä¾èµ–ä½“ç§¯æ£€æŸ¥'
        id: size
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ ä¾èµ–ä½“ç§¯åˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          NODE_MODULES_SIZE=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "unknown")
          DEPENDENCY_COUNT=$(npm ls --depth=0 2>/dev/null | grep -c "^[â”œâ””]" || echo "0")

          echo "- **node_modules ä½“ç§¯**: $NODE_MODULES_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›´æ¥ä¾èµ–æ•°é‡**: $DEPENDENCY_COUNT" >> $GITHUB_STEP_SUMMARY

          echo "size=$NODE_MODULES_SIZE" >> $GITHUB_OUTPUT
          echo "count=$DEPENDENCY_COUNT" >> $GITHUB_OUTPUT

      - name: 'åˆ›å»º PR è¯„è®º'
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const auditStatus = '${{ steps.audit.outputs.audit_status }}';
            const licenseStatus = '${{ steps.license.outputs.license_status }}';
            const depSize = '${{ steps.size.outputs.size }}';
            const depCount = '${{ steps.size.outputs.count }}';

            const statusEmoji = (status) => {
              if (status === 'clean' || status === 'ok') return 'âœ…';
              if (status === 'warning' || status === 'violation') return 'âš ï¸';
              return 'â“';
            };

            let body = '## ğŸ” ä¾èµ–å®¡æŸ¥æ‘˜è¦\n\n';
            body += '| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |\n';
            body += '|-------|--------|---------|\n';
            body += `| å®‰å…¨å®¡è®¡ | ${statusEmoji(auditStatus)} | ${auditStatus === 'clean' ? 'æ— æ¼æ´' : 'éœ€è¦å®¡æŸ¥'} |\n`;
            body += `| è®¸å¯è¯æ£€æŸ¥ | ${statusEmoji(licenseStatus)} | ${licenseStatus === 'ok' ? 'åˆè§„' : 'æ£€æµ‹åˆ°è¿è§„'} |\n`;
            body += `| ä¾èµ–ä¿¡æ¯ | ğŸ“¦ | ${depCount} ä¸ªç›´æ¥ä¾èµ–ï¼Œæ€»ä½“ç§¯ ${depSize} |\n`;

            if (auditStatus === 'warning' || licenseStatus === 'violation') {
              body += '\nâš ï¸ **éœ€è¦å¤„ç†**ï¼šè¯·æŸ¥çœ‹ [å·¥ä½œæµæ‘˜è¦](' + process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID + ') ä¸­çš„å®¡è®¡ç»“æœã€‚\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
