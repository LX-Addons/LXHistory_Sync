name: Build and Check Browser Extension

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Dependency audit
        run: npm audit --production || true
        continue-on-error: true

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Lint check
        run: |
          if [ -f "package.json" ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "‚ÑπÔ∏è ESLint not configured, skipping lint check"
          fi

      - name: Format check
        run: |
          if [ -f "package.json" ] && grep -q "prettier" package.json; then
            npm run format:check
          else
            echo "‚ÑπÔ∏è Prettier not configured, skipping format check"
          fi

      - name: Check manifest validity
        run: |
          if [ -f "package.json" ]; then
            echo "‚úì Checking manifest configuration in package.json"
            cat package.json | grep -A 20 "manifest"
          else
            echo "‚úó package.json not found"
            exit 1
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get project version
        id: get_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          PROJECT_NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "build_dir=${PROJECT_NAME}-${VERSION}" >> $GITHUB_OUTPUT
          echo "zip_file=${PROJECT_NAME}-${VERSION}.zip" >> $GITHUB_OUTPUT

      - name: Build extension
        run: npm run build

      - name: Verify build success
        run: |
          if [ ! -d "build" ]; then
            echo "‚úó Build directory not found"
            exit 1
          fi
          # Find production build directory (flexible for different plasmo configs)
          PROD_BUILD=$(find build -type d -name "chrome-mv3-prod" -o -name "*-mv3-prod" | head -1)
          if [ -z "$PROD_BUILD" ]; then
            echo "‚úó Production build directory not found"
            echo "Available directories in build/:"
            ls -la build/
            exit 1
          fi
          echo "‚úì Production build directory found: $PROD_BUILD"

      - name: Check manifest.json
        run: |
          PROD_BUILD=$(find build -type d -name "chrome-mv3-prod" -o -name "*-mv3-prod" | head -1)
          if [ -f "$PROD_BUILD/manifest.json" ]; then
            echo "‚úì manifest.json exists"
            cat "$PROD_BUILD/manifest.json"
            if command -v jq &> /dev/null; then
              jq '.' "$PROD_BUILD/manifest.json"
              echo "‚úì manifest.json is valid JSON"
            else
              echo "‚ÑπÔ∏è jq not available, skipping JSON validation"
            fi
          else
            echo "‚úó manifest.json not found"
            exit 1
          fi

      - name: Package extension
        if: github.event_name == 'workflow_dispatch'
        run: npm run package

      - name: Rename build artifacts
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          PROJECT_NAME=${{ steps.get_version.outputs.project_name }}
          BUILD_DIR=${{ steps.get_version.outputs.build_dir }}
          ZIP_FILE=${{ steps.get_version.outputs.zip_file }}

          PROD_BUILD=$(find build -type d -name "chrome-mv3-prod" -o -name "*-mv3-prod" | head -1)

          if [ -n "$PROD_BUILD" ]; then
            mv "$PROD_BUILD" "build/$BUILD_DIR"
            echo "‚úì Renamed build directory to build/$BUILD_DIR"
          fi

          ZIP_PATH=$(find build -name "*.zip" | head -1)
          if [ -f "$ZIP_PATH" ]; then
            mv "$ZIP_PATH" "build/$ZIP_FILE"
            echo "‚úì Renamed zip file to build/$ZIP_FILE"
          fi

      - name: Verify zip file creation
        if: github.event_name == 'workflow_dispatch'
        run: |
          ZIP_FILE=$(find build -name "*.zip" | head -1)
          if [ -f "$ZIP_FILE" ]; then
            echo "‚úì Zip file created: $ZIP_FILE"
            ls -la "$ZIP_FILE"
            ZIP_SIZE=$(wc -c < "$ZIP_FILE")
            echo "‚úì Zip file size: $ZIP_SIZE bytes"
            if [ "$ZIP_SIZE" -lt 1000 ]; then
              echo "‚ö†Ô∏è Zip file is very small, may be incomplete"
            fi
          else
            echo "‚úó Zip file not found"
            exit 1
          fi

      - name: Verify build artifacts
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üìÅ Build artifacts:"
          ls -la build/
          VERSION=${{ steps.get_version.outputs.version }}
          PROJECT_NAME=${{ steps.get_version.outputs.project_name }}
          BUILD_DIR="build/${PROJECT_NAME}-${VERSION}"
          if [ -d "$BUILD_DIR" ]; then
            echo "üìÅ Production build:"
            ls -la "$BUILD_DIR"
            REQUIRED_FILES=("manifest.json" "popup.html")
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$BUILD_DIR/$file" ]; then
                echo "‚úì $file exists"
              else
                echo "‚úó $file missing"
                exit 1
              fi
            done
            if [ -f "$BUILD_DIR/background.js" ] || [ -f "$BUILD_DIR/background/index.js" ]; then
              echo "‚úì background script exists"
            else
              echo "‚ÑπÔ∏è background script not found"
            fi
          else
            echo "‚úó Build directory not found"
            exit 1
          fi

      - name: Security check
        run: |
          echo "üîí Running security checks..."
          SECURITY_ISSUES=0

          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | head -1; then
            echo "‚ö†Ô∏è  Found eval() usage, potential security risk"
            SECURITY_ISSUES=1
          else
            echo "‚úì No eval() usage found"
          fi

          if grep -r "innerHTML" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | head -1; then
            echo "‚ö†Ô∏è  Found innerHTML usage, potential XSS risk"
            SECURITY_ISSUES=1
          else
            echo "‚úì No innerHTML usage found"
          fi

          if grep -r "dangerouslySetInnerHTML" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | head -1; then
            echo "‚ö†Ô∏è  Found dangerouslySetInnerHTML usage, potential XSS risk"
            SECURITY_ISSUES=1
          else
            echo "‚úì No dangerouslySetInnerHTML usage found"
          fi

          if [ $SECURITY_ISSUES -eq 0 ]; then
            echo "‚úÖ All security checks passed"
          else
            echo "‚ö†Ô∏è  Security issues found, please review"
          fi

      - name: List build directory
        run: |
          echo "üìÅ Build directory contents:"
          ls -la build/
          echo "üìÅ Chrome MV3 Prod contents:"
          ls -la build/chrome-mv3-prod/ || echo "Directory not found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: |
            build/chrome-mv3-prod/
          retention-days: 7

      - name: Create Release
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          TAG_NAME="v${VERSION}"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag $TAG_NAME already exists, skipping release creation"
            echo "‚ÑπÔ∏è To create a new release, update the version in package.json"
          else
            echo "üì¶ Creating release for version $VERSION"
            gh release create "$TAG_NAME" \
              --title "Release v$VERSION" \
              --notes "## LXHistory_Sync Release

            ### Version
            $VERSION

            ### Changes
            - Manual build from GitHub Actions
            - Latest code changes

            ### Files
            - Chrome extension zip file
            - Build artifacts" \
              build/*.zip
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary"
          echo "‚úÖ All checks passed"
          echo "‚úÖ Build completed successfully"
          echo "‚úÖ TypeScript check passed"
          echo "‚úÖ Dependency audit completed"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "‚úÖ Extension packaged"
            ZIP_FILE=$(find build -name "*.zip" | head -1)
            if [ -f "$ZIP_FILE" ]; then
              echo "‚úÖ Zip file: $(basename "$ZIP_FILE")"
            fi
            echo "‚úÖ Build artifacts uploaded"
            echo "‚úÖ Release created"
            echo "‚úÖ Ready for deployment"
          else
            echo "‚úÖ Code inspection completed"
            echo "‚úÖ No issues found"
            echo "‚ÑπÔ∏è Package and release steps skipped (manual trigger only)"
          fi

  unit-test:
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Run unit tests
        run: npm run test:unit

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/
          retention-days: 7

  e2e-test:
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-build
          path: build/chrome-mv3-prod/

      - name: Verify downloaded build
        run: |
          echo "üìÅ Downloaded build contents:"
          ls -la build/
          echo "üìÅ Chrome MV3 Prod contents:"
          ls -la build/chrome-mv3-prod/ || echo "Directory not found"
          echo "üìÅ manifest.json:"
          cat build/chrome-mv3-prod/manifest.json || echo "manifest.json not found"

      - name: Run E2E tests
        run: xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7
