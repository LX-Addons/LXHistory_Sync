name: æ¸…é™¤ GitHub Actions ç¼“å­˜

on:
  workflow_dispatch:
    inputs:
      cache_prefix:
        description: "è¦æ¸…é™¤çš„ç¼“å­˜å‰ç¼€ï¼ˆç•™ç©ºåˆ™æ¸…é™¤æ‰€æœ‰ï¼‰"
        required: false
        type: string
        default: ""

permissions:
  actions: write
  contents: read

jobs:
  clear-caches:
    name: æ¸…é™¤ç¼“å­˜
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de59f58f8d77ea5d75f7d5e48b9c23d1c5c4c948  # v4.1.4

      - name: æ¸…é™¤ç¼“å­˜
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const prefix = '${{ inputs.cache_prefix }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`æ­£åœ¨è·å–ä»“åº“ ${owner}/${repo} çš„ç¼“å­˜åˆ—è¡¨...`);
            
            let cachesCleared = 0;
            let page = 1;
            const perPage = 100;
            
            while (true) {
              const { data: { actions_caches: caches } } = await github.rest.actions.getActionsCacheList({
                owner,
                repo,
                per_page: perPage,
                page: page
              });
              
              if (!caches || caches.length === 0) {
                break;
              }
              
              for (const cache of caches) {
                const shouldDelete = !prefix || cache.key.startsWith(prefix);
                
                if (shouldDelete) {
                  console.log(`åˆ é™¤ç¼“å­˜: ${cache.key} (ID: ${cache.id})`);
                  try {
                    await github.rest.actions.deleteActionsCacheById({
                      owner,
                      repo,
                      cache_id: cache.id
                    });
                    cachesCleared++;
                  } catch (error) {
                    console.error(`åˆ é™¤ç¼“å­˜ ${cache.key} å¤±è´¥:`, error.message);
                  }
                }
              }
              
              if (caches.length < perPage) {
                break;
              }
              page++;
            }
            
            console.log(`\nâœ… æˆåŠŸæ¸…é™¤äº† ${cachesCleared} ä¸ªç¼“å­˜`);
            
            if (prefix) {
              console.log(`ğŸ” ç­›é€‰å‰ç¼€: "${prefix}"`);
            } else {
              console.log(`ğŸ” æ¸…é™¤äº†æ‰€æœ‰ç¼“å­˜`);
            }
            
            core.setOutput('caches_cleared', cachesCleared);
