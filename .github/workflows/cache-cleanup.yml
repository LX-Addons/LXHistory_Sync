name: ğŸ§¹ ç¼“å­˜æ¸…ç†

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    name: æ¸…ç†ç¼“å­˜
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ—‘ï¸ æ¸…ç† PR ç¼“å­˜
        run: |
          echo "ğŸ“‹ æ­£åœ¨è·å–ç¼“å­˜åˆ—è¡¨..."
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"
          else
            BRANCH="${{ github.ref }}"
          fi
          
          echo "ğŸ“Œ ç›®æ ‡åˆ†æ”¯: $BRANCH"
          
          cacheKeysForPR=$(gh cache list --ref "$BRANCH" --limit 100 --json id --jq '.[].id')
          
          if [ -z "$cacheKeysForPR" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°è¯¥åˆ†æ”¯çš„ç¼“å­˜"
            exit 0
          fi
          
          echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ç¼“å­˜..."
          for cacheKey in $cacheKeysForPR
          do
              gh cache delete $cacheKey
              echo "âœ… å·²åˆ é™¤ç¼“å­˜: $cacheKey"
          done
          
          echo "ğŸ‰ ç¼“å­˜æ¸…ç†å®Œæˆï¼"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
