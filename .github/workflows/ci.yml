name: æ„å»ºä¸æ£€æŸ¥æµè§ˆå™¨æ‰©å±•

on:
  push:
    branches: [main, beta, release]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      create_release:
        description: "åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
        required: false
        default: false
        type: boolean
      skip_e2e:
        description: "è·³è¿‡ E2E æµ‹è¯•ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰"
        required: false
        default: false
        type: boolean
      clear_caches:
        description: "æ¸…é™¤æ—§çš„ npm å’Œ Plasmo ç¼“å­˜åå†æ„å»º"
        required: false
        default: false
        type: boolean

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' || !contains(fromJSON('["main", "beta", "release"]'), github.ref_name) }}

env:
  NODE_VERSION: "20"
  EXTENSION_SIZE_LIMIT_MB: 10

jobs:
  setup:
    name: å‡†å¤‡ç¯å¢ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      actions: write
      contents: read
    outputs:
      cache_key: ${{ steps.cache-key.outputs.key }}
      artifact_retention: ${{ steps.retention.outputs.days }}
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: ç”Ÿæˆç¼“å­˜ key
        id: cache-key
        run: |
          CACHE_KEY="${{ runner.os }}-${{ github.ref_name }}-node-${{ hashFiles('**/package-lock.json') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "ğŸ“ ç¼“å­˜ Key: $CACHE_KEY"

      - name: è®¾ç½®äº§ç‰©ä¿ç•™å¤©æ•°
        id: retention
        run: |
          if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "beta" || "${{ github.ref_name }}" == "release" ]]; then
            echo "days=30" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "days=14" >> $GITHUB_OUTPUT
          else
            echo "days=7" >> $GITHUB_OUTPUT
          fi

      - name: æ¸…é™¤å½“å‰åˆ†æ”¯æ—§ç¼“å­˜
        if: ${{ github.event.inputs.clear_caches == 'true' || github.event_name == 'push' }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branchPrefix = '${{ github.ref_name }}'.replace(/[^a-zA-Z0-9-]/g, '-');
            const prefixes = [
              '${{ runner.os }}-' + branchPrefix + '-node-',
              '${{ runner.os }}-' + branchPrefix + '-plasmo-'
            ];
            let cachesCleared = 0;
            
            console.log('ğŸ” æ­£åœ¨æ¸…é™¤å½“å‰åˆ†æ”¯ç›¸å…³ç¼“å­˜...');
            
            for (const prefix of prefixes) {
              let page = 1;
              const perPage = 100;
              
              while (true) {
                const { data: { actions_caches: caches } } = await github.rest.actions.getActionsCacheList({
                  owner,
                  repo,
                  per_page: perPage,
                  page: page
                });
                
                if (!caches || caches.length === 0) break;
                
                for (const cache of caches) {
                  if (cache.key.startsWith(prefix)) {
                    console.log(`ğŸ—‘ï¸ åˆ é™¤ç¼“å­˜: ${cache.key}`);
                    try {
                      await github.rest.actions.deleteActionsCacheById({
                        owner,
                        repo,
                        cache_id: cache.id
                      });
                      cachesCleared++;
                    } catch (error) {
                      console.error(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
                    }
                  }
                }
                
                if (caches.length < perPage) break;
                page++;
              }
            }
            
            console.log(`\nâœ… æˆåŠŸæ¸…é™¤ ${cachesCleared} ä¸ªç¼“å­˜`);

      - name: è¾“å‡ºå‡†å¤‡æ‘˜è¦
        run: |
          echo "## ğŸš€ ç¯å¢ƒå‡†å¤‡å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **åˆ†æ”¯** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **äº‹ä»¶ç±»å‹** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç¼“å­˜ Key** | \`${{ steps.cache-key.outputs.key }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **äº§ç‰©ä¿ç•™** | ${{ steps.retention.outputs.days }} å¤© |" >> $GITHUB_STEP_SUMMARY

  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs: [setup]
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-node-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npm run typecheck

      - name: ESLint ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: Prettier æ ¼å¼æ£€æŸ¥
        run: npm run format:check

      - name: è¾“å‡ºæ£€æŸ¥æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ” ä»£ç æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript ç±»å‹æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint ä»£ç æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier æ ¼å¼æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY

  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    needs: [setup]
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: é…ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: ${{ matrix.node-version }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-${{ github.ref_name }}-node${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-node${{ matrix.node-version }}-
            ${{ runner.os }}-node${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: npm run test:unit -- --coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ä¸Šä¼ æµ‹è¯•äº§ç‰©
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: test-coverage-node${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: ${{ needs.setup.outputs.artifact_retention }}
          if-no-files-found: warn

  sonarcloud:
    name: SonarCloud ä»£ç æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    needs: [setup, test]
    if: needs.test.result == 'success'
    steps:
      - name: æ£€æŸ¥ SonarCloud é…ç½®
        id: check_sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -n "$SONAR_TOKEN" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::SONAR_TOKEN æœªé…ç½®ï¼Œè·³è¿‡ SonarCloud æ‰«æ"
          fi

      - name: æ£€å‡ºä»“åº“
        if: steps.check_sonar.outputs.configured == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æµ‹è¯•è¦†ç›–ç‡äº§ç‰©
        if: steps.check_sonar.outputs.configured == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          pattern: test-coverage-*
          path: .
          merge-multiple: true

      - name: SonarCloud æ‰«æ
        if: steps.check_sonar.outputs.configured == 'true'
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ä¸Šä¼  SonarCloud äº§ç‰©
        if: always() && steps.check_sonar.outputs.configured == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: sonarcloud-report
          path: .scannerwork/
          retention-days: ${{ needs.setup.outputs.artifact_retention }}
          if-no-files-found: warn

  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    needs: [setup]
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-node-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: æ£€æŸ¥å¯†é’¥æ³„éœ²
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: ä¾èµ–å®‰å…¨å®¡è®¡
        run: |
          echo "### ğŸ›¡ï¸ ä¾èµ–å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å®¡è®¡æŠ¥å‘Š</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: å®‰å…¨æ¨¡å¼æ£€æŸ¥
        run: |
          echo "### ğŸ” å®‰å…¨æ¨¡å¼æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          EXIT_CODE=0
          
          echo "#### eval ä½¿ç”¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules | grep -v ".plasmo"; then
            echo "âŒ å‘ç° eval() ä½¿ç”¨ - æ½œåœ¨å®‰å…¨é£é™©" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          else
            echo "âœ… æœªå‘ç° eval() ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "#### dangerouslySetInnerHTML æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          if grep -r "dangerouslySetInnerHTML" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules | grep -v ".plasmo"; then
            echo "âš ï¸ å‘ç° dangerouslySetInnerHTML ä½¿ç”¨ - XSS é£é™©" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªå‘ç° dangerouslySetInnerHTML ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          exit $EXIT_CODE

      - name: ä¸Šä¼ å®‰å…¨æ‰«æäº§ç‰©
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: security-scan-results
          path: |
            .trufflehog/
          retention-days: ${{ needs.setup.outputs.artifact_retention }}
          if-no-files-found: ignore

  build:
    name: æ„å»ºæ‰©å±•
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    needs: [setup, lint, test, sonarcloud, security]
    if: needs.lint.result == 'success' && needs.test.result == 'success' && (needs.sonarcloud.result == 'success' || needs.sonarcloud.result == 'skipped') && (needs.security.result == 'success' || needs.security.result == 'skipped')
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.version.outputs.name }}
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-node-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: ç¼“å­˜ Plasmo æ„å»ºç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: .plasmo
          key: ${{ runner.os }}-${{ github.ref_name }}-plasmo-${{ hashFiles('**/package-lock.json', '**/*.ts', '**/*.tsx', '**/*.css', 'assets/*') }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-plasmo-
            ${{ runner.os }}-plasmo-

      - name: æ„å»ºæ‰©å±•
        run: npm run build:ci

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ‰©å±•ä½“ç§¯
        run: |
          BUILD_DIR="build/chrome-mv3-prod"
          if [ -d "$BUILD_DIR" ]; then
            SIZE_KB=$(du -sk "$BUILD_DIR" | cut -f1)
            SIZE_MB=$((SIZE_KB / 1024))
            echo "ğŸ“Š æ‰©å±•ä½“ç§¯: ${SIZE_MB}MB (${SIZE_KB}KB)"
            
            if [ "$SIZE_MB" -gt "${{ env.EXTENSION_SIZE_LIMIT_MB }}" ]; then
              echo "âŒ æ‰©å±•ä½“ç§¯ (${SIZE_MB}MB) è¶…å‡ºé™åˆ¶ (${{ env.EXTENSION_SIZE_LIMIT_MB }}MB)"
              exit 1
            fi
            echo "âœ… æ‰©å±•ä½“ç§¯ç¬¦åˆé™åˆ¶"
          fi

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          BUILD_DIR="build/chrome-mv3-prod"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨: $BUILD_DIR"
            exit 1
          fi
          
          echo "ğŸ“ æ„å»ºå†…å®¹:"
          ls -la "$BUILD_DIR"
          
          REQUIRED_FILES=("manifest.json" "popup.html")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$BUILD_DIR/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
              exit 1
            fi
          done

      - name: æ‰“åŒ…æ‰©å±•
        run: npm run package

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        run: |
          VERSION=${{ steps.version.outputs.version }}
          NAME=${{ steps.version.outputs.name }}
          
          if [ -d "build/chrome-mv3-prod" ]; then
            mv "build/chrome-mv3-prod" "build/${NAME}-${VERSION}-chrome"
          fi
          
          if [ -f "build/chrome-mv3-prod.zip" ]; then
            mv "build/chrome-mv3-prod.zip" "build/${NAME}-${VERSION}-chrome.zip"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: extension-${{ steps.version.outputs.version }}
          path: build/
          retention-days: ${{ needs.setup.outputs.artifact_retention }}

      - name: è¾“å‡ºæ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸ“¦ æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **åç§°** | \`${{ steps.version.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **äº§ç‰©ä¿ç•™** | ${{ needs.setup.outputs.artifact_retention }} å¤© |" >> $GITHUB_STEP_SUMMARY

  e2e:
    name: E2Eæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    needs: [setup, build]
    if: needs.build.result == 'success' && github.event.inputs.skip_e2e != 'true'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-node-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          pattern: extension-*
          path: build/
          merge-multiple: true

      - name: å‡†å¤‡æµ‹è¯•æ‰©å±•
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          
          if [ -d "build/${NAME}-${VERSION}-chrome" ]; then
            mv "build/${NAME}-${VERSION}-chrome" "build/chrome-mv3-prod"
          fi
          
          ls -la build/

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install --with-deps chromium

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: xvfb-run --auto-servernum npm run test:e2e

      - name: ä¸Šä¼  Playwright æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: ${{ needs.setup.outputs.artifact_retention }}
          if-no-files-found: warn

  pr-comment:
    name: PRè¯„è®º
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
    needs: [setup, lint, test, sonarcloud, security, build, e2e]
    if: always() && github.event_name == 'pull_request' && (needs.lint.result == 'success' || needs.lint.result == 'failure') && (needs.test.result == 'success' || needs.test.result == 'failure')
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: info
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦ä¸º Dependabot PR
        id: dependabot
        run: |
          if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º PR è¯„è®º
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const setupResult = '${{ needs.setup.result }}';
            const lintResult = '${{ needs.lint.result }}';
            const testResult = '${{ needs.test.result }}';
            const sonarcloudResult = '${{ needs.sonarcloud.result }}';
            const securityResult = '${{ needs.security.result }}';
            const buildResult = '${{ needs.build.result }}';
            const e2eResult = '${{ needs.e2e.result }}';
            const version = '${{ steps.info.outputs.version }}';
            const isDependabot = '${{ steps.dependabot.outputs.is_dependabot }}' === 'true';
            
            const statusEmoji = (result) => {
              if (result === 'success') return 'âœ…';
              if (result === 'failure') return 'âŒ';
              if (result === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };
            
            const statusColor = (result) => {
              if (result === 'success') return 'brightgreen';
              if (result === 'failure') return 'red';
              return 'yellow';
            };
            
            const getBadge = (label, result) => {
              const color = statusColor(result);
              return `![${label}](https://img.shields.io/badge/${encodeURIComponent(label)}-${result}-${color}?style=flat-square)`;
            };

            let body = `## ğŸ› ï¸ æ‰©å±•æ„å»ºä»ªè¡¨ç›˜\n\n`;
            body += `> **ç‰ˆæœ¬:** \`${version}\` | **åˆ†æ”¯:** \`${{ github.ref_name }}\` | **è¿è¡Œ ID:** [#${{ github.run_number }}](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n\n`;
            
            body += `### ğŸ“Š æ£€æŸ¥ç»“æœæ¦‚è§ˆ\n\n`;
            body += `| é˜¶æ®µ | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |\n`;
            body += `| :---: | :--- | :---: | :--- |\n`;
            body += `| ğŸš€ | **ç¯å¢ƒå‡†å¤‡** | ${statusEmoji(setupResult)} | ç¼“å­˜ä¸äº§ç‰©é…ç½® |\n`;
            body += `| ğŸ” | **ä»£ç æ£€æŸ¥** | ${statusEmoji(lintResult)} | TypeScript + ESLint + Prettier |\n`;
            body += `| ğŸ§ª | **å•å…ƒæµ‹è¯•** | ${statusEmoji(testResult)} | Node.js 20/22 å¤šç‰ˆæœ¬æµ‹è¯• |\n`;
            body += `| ğŸ“Š | **SonarCloud** | ${statusEmoji(sonarcloudResult)} | ä»£ç è´¨é‡ä¸è¦†ç›–ç‡æ‰«æ |\n`;
            body += `| ğŸ›¡ï¸ | **å®‰å…¨æ‰«æ** | ${statusEmoji(securityResult)} | å¯†é’¥æ³„éœ² + ä¾èµ–å®¡è®¡ |\n`;
            body += `| ğŸ“¦ | **æ‰©å±•æ„å»º** | ${statusEmoji(buildResult)} | Plasmo ç”Ÿäº§æ„å»º |\n`;
            body += `| ğŸ­ | **E2E æµ‹è¯•** | ${statusEmoji(e2eResult)} | Playwright æµè§ˆå™¨æµ‹è¯• |\n\n`;
            
            body += `### ğŸ·ï¸ çŠ¶æ€å¾½ç« \n\n`;
            body += `${getBadge('ä»£ç æ£€æŸ¥', lintResult)} ${getBadge('å•å…ƒæµ‹è¯•', testResult)} ${getBadge('SonarCloud', sonarcloudResult)} ${getBadge('å®‰å…¨æ‰«æ', securityResult)} ${getBadge('æ„å»º', buildResult)} ${getBadge('E2Eæµ‹è¯•', e2eResult)}\n\n`;
            
            const results = {
              lint: lintResult,
              test: testResult,
              sonarcloud: sonarcloudResult,
              security: securityResult,
              build: buildResult
            };
            const allSuccess = ['lint', 'test', 'sonarcloud', 'security', 'build'].every(r => 
              results[r] === 'success'
            );
            const e2eSuccess = e2eResult === 'success' || e2eResult === 'skipped';
            
            if (allSuccess && e2eSuccess) {
              body += `> ğŸ‰ **æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼** ä»£ç å·²å‡†å¤‡å¥½åˆå¹¶ã€‚\n\n`;
            } else {
              body += `> âš ï¸ **éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡**ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹è¯¦æƒ…æˆ–æ£€æŸ¥æ—¥å¿—ã€‚\n\n`;
            }
            
            if (buildResult === 'success') {
              body += `---\n\n`;
              body += `### ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©\n\n`;
              body += `æ„å»ºäº§ç‰©å¯åœ¨ [å·¥ä½œæµè¿è¡Œé¡µé¢](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) çš„ **Artifacts** åŒºåŸŸä¸‹è½½ã€‚\n\n`;
            }
            
            if (isDependabot) {
              body += `---\n\n`;
              body += `### ğŸ¤– Dependabot ä¾èµ–æ›´æ–°\n\n`;
              if (allSuccess && e2eSuccess) {
                body += `âœ… æ‰€æœ‰å…³é”®æ£€æŸ¥å·²é€šè¿‡ï¼Œå·²æ·»åŠ  \`å¾…å®¡æ ¸\` æ ‡ç­¾ã€‚\n\n`;
                body += `âš ï¸ **éœ€è¦äººå·¥å®¡æ ¸åæ‰èƒ½åˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚**\n`;
              } else {
                body += `âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œéœ€è¦äººå·¥å®¡æ ¸ã€‚\n`;
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    needs: [setup, build, e2e, security, sonarcloud]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.sonarcloud.result == 'success' || needs.sonarcloud.result == 'skipped') &&
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.create_release == 'true'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          pattern: extension-*
          path: build/
          merge-multiple: true

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          CURRENT_VERSION="${{ steps.version.outputs.version }}"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES=$(npx git-cliff --strip header 2>/dev/null || echo "åˆå§‹å‘å¸ƒ v${CURRENT_VERSION}")
          else
            NOTES=$(npx git-cliff "${PREVIOUS_TAG}..HEAD" --strip header 2>/dev/null || echo "å‘å¸ƒ v${CURRENT_VERSION}")
          fi
          
          if [ -z "$NOTES" ] || [ "$NOTES" = "## [Unreleased]" ]; then
            NOTES="## æ›´æ–°å†…å®¹\n\n- ç‰ˆæœ¬æ›´æ–°è‡³ ${CURRENT_VERSION}"
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: å‘å¸ƒ v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          files: |
            build/*.zip
          draft: false
          prerelease: ${{ github.ref != 'refs/heads/main' }}
          generate_release_notes: false

      - name: å‘å¸ƒæ‘˜è¦
        run: |
          echo "## ğŸ‰ å‘å¸ƒå·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬** | \`v${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ç±»å‹** | ${{ github.ref == 'refs/heads/main' && 'æ­£å¼ç‰ˆ' || 'é¢„å‘å¸ƒç‰ˆ' }} |" >> $GITHUB_STEP_SUMMARY

  dependabot-notify:
    name: Dependaboté€šçŸ¥
    runs-on: ubuntu-latest
    needs: [setup, lint, test, sonarcloud, security, build, e2e]
    if: |
      github.event_name == 'pull_request' &&
      github.actor == 'dependabot[bot]' &&
      needs.lint.result == 'success' &&
      needs.test.result == 'success' &&
      (needs.sonarcloud.result == 'success' || needs.sonarcloud.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped')
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: æ·»åŠ å¾…å®¡æ ¸æ ‡ç­¾
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['å¾…å®¡æ ¸']
            })
            core.info('âœ… å·²æ·»åŠ å¾…å®¡æ ¸æ ‡ç­¾ï¼Œç­‰å¾…äººå·¥å®¡æ ¸ååˆå¹¶')

  notify-failure:
    name: å¤±è´¥é€šçŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    needs: [setup, lint, test, sonarcloud, security, build, e2e]
    if: failure() && github.event_name != 'pull_request'
    steps:
      - name: åˆ›å»ºå¤±è´¥æ‘˜è¦
        run: |
          echo "## âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ | ç¯å¢ƒå‡†å¤‡ | ${{ needs.setup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” | ä»£ç æ£€æŸ¥ | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª | å•å…ƒæµ‹è¯• | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š | SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ›¡ï¸ | å®‰å…¨æ‰«æ | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ | æ„å»º | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ | E2E æµ‹è¯• | ${{ needs.e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ [å·¥ä½œæµæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
