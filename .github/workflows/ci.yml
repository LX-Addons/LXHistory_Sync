name: ðŸ”¨ æŒç»­é›†æˆ

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

permissions:
  contents: read

jobs:
  build-and-test:
    name: æž„å»ºä¸Žæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ§¹ æ¸…ç†æ—§æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ§¹ æ­£åœ¨æ¸…ç†æ—§æž„å»ºäº§ç‰©..."
          rm -rf .plasmo build dist || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ’¾ ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ci-${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ci-${{ runner.os }}-node-

      - name: ðŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci

      - name: ðŸ” ä¾èµ–å®‰å…¨å®¡è®¡
        run: npm audit --production || true
        continue-on-error: true

      - name: ðŸ” ä»£ç æ£€æŸ¥ (ESLint)
        run: |
          if [ -f "package.json" ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "â„¹ï¸ æœªé…ç½® ESLintï¼Œè·³è¿‡æ£€æŸ¥"
          fi

      - name: ðŸ“ æ ¼å¼æ£€æŸ¥ (Prettier)
        run: |
          if [ -f "package.json" ] && grep -q "prettier" package.json; then
            npm run format:check
          else
            echo "â„¹ï¸ æœªé…ç½® Prettierï¼Œè·³è¿‡æ£€æŸ¥"
          fi

      - name: ðŸ“ ç±»åž‹æ£€æŸ¥ (TypeScript)
        run: npx tsc --noEmit

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: npm run test:unit

      - name: ðŸ”¨ æž„å»ºæ‰©å±•ç¨‹åº
        run: npm run build:ci
        env:
          CI: true
          NODE_ENV: production

      - name: âœ… éªŒè¯æž„å»ºäº§ç‰©
        run: |
          PROD_BUILD_PATH=$(find build -type d -name "chrome-mv3-prod" -o -name "*-mv3-prod" | head -1)
          
          if [ -z "$PROD_BUILD_PATH" ] || [ ! -d "$PROD_BUILD_PATH" ]; then
            echo "âŒ ç”Ÿäº§æž„å»ºç›®å½•æœªæ‰¾åˆ°"
            ls -la build/ || true
            exit 1
          fi
          echo "âœ… ç”Ÿäº§æž„å»ºç›®å½•: $PROD_BUILD_PATH"
          
          REQUIRED_FILES=("manifest.json" "popup.html")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$PROD_BUILD_PATH/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
              exit 1
            fi
          done
          
          if command -v jq &> /dev/null; then
            jq '.' "$PROD_BUILD_PATH/manifest.json" > /dev/null
            echo "âœ… manifest.json JSON æ ¼å¼æœ‰æ•ˆ"
          fi

      - name: ðŸ”’ å®‰å…¨æ£€æŸ¥
        run: |
          echo "ðŸ” æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
          SECURITY_ISSUES=0
          
          DANGEROUS_FUNCS=("eval(" "new Function(")
          for func in "${DANGEROUS_FUNCS[@]}"; do
            if grep -r "$func" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | head -1; then
              echo "âš ï¸ å‘çŽ° $func ä½¿ç”¨ï¼Œå­˜åœ¨å®‰å…¨é£Žé™©"
              SECURITY_ISSUES=1
            fi
          done
          
          XSS_RISKS=("innerHTML" "dangerouslySetInnerHTML" "document.write(")
          for risk in "${XSS_RISKS[@]}"; do
            if grep -r "$risk" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | head -1; then
              echo "âš ï¸ å‘çŽ° $risk ä½¿ç”¨ï¼Œå­˜åœ¨ XSS é£Žé™©"
              SECURITY_ISSUES=1
            fi
          done
          
          if grep -rE "api_key|secret|password|token" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v "node_modules" | grep -v ".plasmo" | grep -v "test" | grep -E "['\"][a-zA-Z0-9]{20,}['\"]" | head -1; then
            echo "âš ï¸ å‘çŽ°æ½œåœ¨çš„ç¡¬ç¼–ç å¯†é’¥"
            SECURITY_ISSUES=1
          fi
          
          if [ $SECURITY_ISSUES -eq 0 ]; then
            echo "âœ… æ‰€æœ‰å®‰å…¨æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥"
          fi

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extension-build-${{ github.run_id }}
          path: build/
          retention-days: 7

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç æ£€æŸ¥ (ESLint) | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ¼å¼æ£€æŸ¥ (Prettier) | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹æ£€æŸ¥ (TypeScript) | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»º | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»º ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
